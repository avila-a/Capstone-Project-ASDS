filter(str_detect(cityname, "Würzburg"))
uar_sf <- uar_sf %>%
# Delete cities that I have reviewed the regulations are very week
filter(!str_detect(cityname, "Budapest"),
!str_detect(cityname, "Sofia"),
!str_detect(cityname, "Bucharest"),
!str_detect(cityname, "Suceava"),
!str_detect(cityname, "Salzburg"),
!str_detect(cityname, "Dublin"),
!str_detect(cityname, "Groningen"),
!str_detect(cityname, "Würzburg"),) %>%
# Delete pollution emergencies schemes
filter(em_scheme == FALSE) %>%
# Delete "late" LEZ
filter(!str_detect(cityname, "Barcelona") # applied in 2020
)
## To check if names work
# uar_sf %>% as.data.frame() %>%
#   filter(str_detect(cityname, "Würzburg"))
uar_sf$scheme %>% table()
nuts.sf <- nuts.sf %>% st_make_valid()
# uar_sf <- uar_sf %>% st_make_valid()
# gzones_sf <- gzones_sf %>% st_make_valid()
# gzones_sf_pol <- gzones_sf_pol %>% st_make_valid()
get_buffer_km <- function(data_points, km){
data_points %>%
st_transform(29902) %>% # Irish grid, that uses meters
st_buffer(dist = units::set_units(km, "km")) %>% # How big is the perimeter
st_transform(crs = "+proj=longlat +datum=WGS84")
}
buffer_50_uar <- get_buffer_km(uar_sf, 50)
# <- st_transform(uar_sf, 29902) %>% # Irish grid, that uses meters
#   st_buffer(dist = units::set_units(50, "km")) %>% # How big is the perimeter
#   st_transform(crs = "+proj=longlat +datum=WGS84")
temp <- nuts.sf %>%
mutate(
with_uar_point = ifelse(
NUTS_ID %in%
(st_intersection(nuts.sf, uar_sf)$NUTS_ID %>% unique()),
TRUE, FALSE),
with_uar_50km = ifelse(
NUTS_ID %in%
(st_intersection(nuts.sf, get_buffer_km(uar_sf, 50))$NUTS_ID %>% unique()),
TRUE, FALSE),
with_uar_100km = ifelse(
NUTS_ID %in%
(st_intersection(nuts.sf, get_buffer_km(uar_sf, 100))$NUTS_ID %>% unique()),
TRUE, FALSE),
with_gzones_point = ifelse(
NUTS_ID %in%
(st_intersection(nuts.sf, gzones_sf)$NUTS_ID %>% unique()),
TRUE, FALSE)
)
ggplot(temp %>%
filter(with_gzones_point == TRUE)) +
geom_sf(aes(color = as.factor(LEVL_CODE))) +
geom_sf(data = buffer_50_uar)
gzones_sf
gzones_sf %>% as.data.frame() %>%
filter(str_detect(Bild, "Atlantiques"))
gzones_sf %>% as.data.frame() %>%
filter(str_detect(Bild, "Gers"))
gzones_sf %>% as.data.frame() %>%
filter(str_detect(Bild, "Gironde"))
gzones_sf %>% as.data.frame() %>%
filter(str_detect(Bild, "Vendee"))
gzones_sf %>% as.data.frame() %>%
filter(str_detect(Bild, "Deux"))
gzones_sf %>% as.data.frame() %>%
filter(str_detect(Bild, "Vienne"))
gzones_sf %>% as.data.frame() %>%
filter(str_detect(Bild, "Maine"))
gzones_sf %>% as.data.frame() %>%
filter(str_detect(Bild, "Montpellier"))
gzones_sf %>% as.data.frame() %>%
filter(str_detect(Bild, "Herault"))
## To check if names work
uar_sf %>% as.data.frame() %>%
filter(str_detect(cityname, "Bordeaux"))
## To check if names work
uar_sf %>% as.data.frame() %>%
filter(str_detect(introtext, "expected"))
gzones_sf %>% as.data.frame() %>%
filter(str_detect(Bild, "Creuse"))
gzones_sf %>% as.data.frame() %>%
filter(str_detect(Bild, "Puy"))
gzones_sf %>% as.data.frame() %>%
filter(str_detect(Bild, "Loire"))
filter(str_detect(Bild, "Loire"))
gzones_sf %>% as.data.frame() %>%
filter(str_detect(Bild, "Lyon"))
gzones_sf %>% as.data.frame() %>%
filter(str_detect(Bild, "Loire"))
gzones_sf %>% as.data.frame() %>%
filter(str_detect(Bild, "Loire")) %>%
plot()
gzones_sf %>%
filter(str_detect(Bild, "Loire")) %>%
plot()
gzones_sf %>%
filter(str_detect(Bild, "Loire"))
gzones_sf %>%
filter(str_detect(Bild, "FrankreichLoireZPA"))
gzones_sf %>% as.data.frame() %>%
filter(str_detect(Bild, "FrankreichLoireZPA")) %>% summary()
gzones_sf %>% as.data.frame() %>%
filter(str_detect(Bild, "FrankreichLoireZPA"))
gzones_sf %>% as.data.frame() %>%
filter(str_detect(Bild, "Loire"))
gzones_sf %>% as.data.frame() %>%
filter(str_detect(KML, "FrankreichLoireZPA"))
gzones_sf %>% as.data.frame() %>%
filter(str_detect(KML, "Eure"))
gzones_sf %>% as.data.frame() %>%
filter(str_detect(KML, "Loiret"))
gzones_sf %>% as.data.frame() %>%
filter(str_detect(KML, "cote"))
gzones_sf %>% as.data.frame() %>%
filter(str_detect(KML, "Cote"))
gzones_sf %>% as.data.frame() %>%
filter(str_detect(KML, "drome"))
gzones_sf %>% as.data.frame() %>%
filter(str_detect(KML, "Drome"))
gzones_sf %>% as.data.frame() %>%
filter(str_detect(KML, "Isere"))
gzones_sf %>% as.data.frame() %>%
filter(str_detect(KML, "Savoie"))
gzones_sf %>% as.data.frame() %>%
filter(str_detect(KML, "Nancy"))
gzones_sf %>% as.data.frame() %>%
filter(str_detect(Bild))
gzones_sf %>% as.data.frame() %>%
filter(str_detect(Bild, "Nancy"))
gzones_sf %>% as.data.frame() %>%
filter(str_detect(Bild, "nancy"))
gzones_sf %>% as.data.frame() %>%
filter(str_detect(Bild, "ZPA"))
gzones_sf %>%  #as.data.frame() %>%
filter(str_detect(Bild, "ZPA")) %>% plot
gzones_sf %>%  as.data.frame() %>%
filter(str_detect(Bild, "rennes"))
gzones_sf %>%  as.data.frame() %>%
filter(str_detect(Bild, "Rennes"))
gzones_sf %>%
# Delete cities that I have reviewed the regulations are very week
filter(!str_detect(Bild, "Atlantiques"),
!str_detect(Bild, "Gers"),
!str_detect(Bild, "Gironde"),
!str_detect(Bild, "Vendee"),
!str_detect(Bild, "Deux"),
!str_detect(Bild, "Vienne"),
!str_detect(Bild, "Herault"),
!str_detect(Bild, "Maine"),
!str_detect(Bild, "Creuse"),
!str_detect(Bild, "Maine"),
!str_detect(Bild, "Puy"),
!str_detect(KML, "FrankreichLoireZPA"),
!str_detect(KML, "Eure"),
!str_detect(KML, "Loiret"),
!str_detect(KML, "Cote"),
!str_detect(KML, "Drome"),
!str_detect(KML, "Isere"),
!str_detect(KML, "Savoie"),# x2
!str_detect(KML, "Rennes"))
gzones_sf %>%  as.data.frame()
gzones_sf %>%
# Delete cities that I have reviewed the regulations are very week
## French regions
filter(!str_detect(Bild, "Atlantiques"),
!str_detect(Bild, "Gers"),
!str_detect(Bild, "Gironde"),
!str_detect(Bild, "Vendee"),
!str_detect(Bild, "Deux"),
!str_detect(Bild, "Vienne"),
!str_detect(Bild, "Herault"),
!str_detect(Bild, "Maine"),
!str_detect(Bild, "Creuse"),
!str_detect(Bild, "Maine"),
!str_detect(Bild, "Puy"),
!str_detect(KML, "FrankreichLoireZPA"),
!str_detect(KML, "Eure"),
!str_detect(KML, "Loiret"),
!str_detect(KML, "Cote"),
!str_detect(KML, "Drome"),
!str_detect(KML, "Isere"),
!str_detect(KML, "Savoie"),# x2
!str_detect(KML, "Rennes")) %>%
# Delete cities that have not already applied a LEZ
filter(InPlaceSince < as.Date("2018-01-01")) # Before 2018
gzones_sf %>%  as.data.frame()
gzones_sf %>%
# Delete cities that I have reviewed the regulations are very week
## French regions
filter(!str_detect(Bild, "Atlantiques"),
!str_detect(Bild, "Gers"),
!str_detect(Bild, "Gironde"),
!str_detect(Bild, "Vendee"),
!str_detect(Bild, "Deux"),
!str_detect(Bild, "Vienne"),
!str_detect(Bild, "Herault"),
!str_detect(Bild, "Maine"),
!str_detect(Bild, "Creuse"),
!str_detect(Bild, "Maine"),
!str_detect(Bild, "Puy"),
!str_detect(KML, "FrankreichLoireZPA"),
!str_detect(KML, "Eure"),
!str_detect(KML, "Loiret"),
!str_detect(KML, "Cote"),
!str_detect(KML, "Drome"),
!str_detect(KML, "Isere"),
!str_detect(KML, "Savoie"),# x2
!str_detect(KML, "Rennes")) %>%
# Delete cities that have not already applied a LEZ
filter(InPlaceSince <= as.Date("2018-01-01")) # Before 2018
gzones_sf %>%  as.data.frame()
gzones_sf <- gzones_sf %>%
# Delete cities that I have reviewed the regulations are very week
## French regions
filter(!str_detect(Bild, "Atlantiques"),
!str_detect(Bild, "Gers"),
!str_detect(Bild, "Gironde"),
!str_detect(Bild, "Vendee"),
!str_detect(Bild, "Deux"),
!str_detect(Bild, "Vienne"),
!str_detect(Bild, "Herault"),
!str_detect(Bild, "Maine"),
!str_detect(Bild, "Creuse"),
!str_detect(Bild, "Maine"),
!str_detect(Bild, "Puy"),
!str_detect(KML, "FrankreichLoireZPA"),
!str_detect(KML, "Eure"),
!str_detect(KML, "Loiret"),
!str_detect(KML, "Cote"),
!str_detect(KML, "Drome"),
!str_detect(KML, "Isere"),
!str_detect(KML, "Savoie"),# x2
!str_detect(KML, "Rennes")) %>%
# Delete cities that have not already applied a LEZ
filter(InPlaceSince <= as.Date("2018-01-01")) # Before 2018
# (polygons)
# 1. Create a list of polygons with the latitudes and longitudes
zones <- gzones_sf %>% as.data.frame() %>% dplyr::select(-geometry)
zones_polygons <- apply(
X = t(zones[c("MinLongitude", "MinLatitude",
"MaxLongitude", "MaxLatitude")]),
MARGIN = 2,
function(x){
Polygon(matrix(c(x[1], x[2], # lower left
x[1], x[4], # lower right
x[3], x[4], # upper right
x[3], x[2], # upper left
x[1], x[2]  # The beguinning again
), byrow = TRUE, ncol = 2), hole = FALSE)
})
# This is going for each polygon, transform it into a "Polygons".
p1 <- lapply(seq_along(zones_polygons), function(i){
Polygons(list(zones_polygons[[i]]), ID = row.names(zones)[i])
})
sps = SpatialPolygons(p1,
proj4string = CRS("+proj=longlat +datum=WGS84 +no_defs"))
gzones_sp_pol <- SpatialPolygonsDataFrame(sps,
data = zones)
gzones_sf_pol <- st_as_sf(gzones_sp_pol)
# New Leaflet map
library(leaflet)
library(htmlwidgets)
nbg
nuts.sf <- nuts.sf %>% st_make_valid()
nuts.sf <- nuts.sf %>% st_make_valid()
get_buffer_km <- function(data_points, km){
data_points %>%
st_transform(29902) %>% # Irish grid, that uses meters
st_buffer(dist = units::set_units(km, "km")) %>% # How big is the perimeter
st_transform(crs = "+proj=longlat +datum=WGS84")
}
buffer_50_uar <- get_buffer_km(uar_sf, 50)
temp <- nuts.sf %>%
mutate(
with_uar_point = ifelse(
NUTS_ID %in%
(st_intersection(nuts.sf, uar_sf)$NUTS_ID %>% unique()),
TRUE, FALSE),
with_uar_50km = ifelse(
NUTS_ID %in%
(st_intersection(nuts.sf, get_buffer_km(uar_sf, 50))$NUTS_ID %>% unique()),
TRUE, FALSE),
with_uar_100km = ifelse(
NUTS_ID %in%
(st_intersection(nuts.sf, get_buffer_km(uar_sf, 100))$NUTS_ID %>% unique()),
TRUE, FALSE),
with_gzones_point = ifelse(
NUTS_ID %in%
(st_intersection(nuts.sf, gzones_sf)$NUTS_ID %>% unique()),
TRUE, FALSE)
)
ggplot(temp %>%
filter(with_gzones_point == TRUE)) +
geom_sf(aes(color = as.factor(LEVL_CODE))) +
geom_sf(data = buffer_50_uar)
ggplot(temp %>%
filter(with_uar_50km == TRUE)) +
geom_sf(aes(color = as.factor(LEVL_CODE))) +
geom_sf(data = buffer_50_uar)
# New Leaflet map
library(leaflet)
library(htmlwidgets)
col_map <- c("red", "blue", "green")
col_size <- c(4,3,1,2)
policy_map <- leaflet() %>%
addTiles() %>%
addPolygons(data = nuts.sf,
color = "black",
weight = 1,
# opacity = NA,
fill = NA) %>%
addPolygons(
data = gzones_sf_pol,
popup = paste0("<b> Name: </b>", gzones_sf_pol$KML,
"<br/> <b> In place since: </b>", gzones_sf_pol$InPlaceSince,
"<br/> <b> Country: </b>", gzones_sf_pol$TitelLocal,
"<br/> <b> Source: </b> GreenZonesApp")) %>%
addCircleMarkers(
data = uar_sf, weight = NA,
opacity = 0.1,
color = NA,
fillColor = col_map[uar_sf$scheme_color],
fillOpacity = 0.9,
radius = col_size[uar_sf$scheme_color]*2,
popup = paste0("<b>", uar_sf$cityname, "</b> <br/>",
"<b> Scheme: </b>", uar_sf$scheme, "<br/>",
"<b> Source: </b> U.A.R")
)
policy_map
htmlwidgets::saveWidget(policy_map, file="policy_map.html")
temp <- nuts.sf %>%
mutate(
with_uar_point = ifelse(
NUTS_ID %in%
(st_intersection(nuts.sf, uar_sf)$NUTS_ID %>% unique()),
TRUE, FALSE),
with_uar_50km = ifelse(
NUTS_ID %in%
(st_intersection(nuts.sf, get_buffer_km(uar_sf, 50))$NUTS_ID %>% unique()),
TRUE, FALSE),
with_uar_100km = ifelse(
NUTS_ID %in%
(st_intersection(nuts.sf, get_buffer_km(uar_sf, 100))$NUTS_ID %>% unique()),
TRUE, FALSE),
with_gzones_point = ifelse(
NUTS_ID %in%
(st_intersection(nuts.sf, gzones_sf)$NUTS_ID %>% unique()),
TRUE, FALSE),
with_gzones_50m = ifelse(
NUTS_ID %in%
(st_intersection(nuts.sf,  get_buffer_km(gzones_sf, 50))$NUTS_ID %>% unique()),
TRUE, FALSE),
with_gzones_100km = ifelse(
NUTS_ID %in%
(st_intersection(nuts.sf,  get_buffer_km(gzones_sf, 100))$NUTS_ID %>% unique()),
TRUE, FALSE)
)
ggplot(temp %>%
filter(with_uar_50km == TRUE)) +
geom_sf(aes(color = as.factor(LEVL_CODE))) +
geom_sf(data = buffer_50_uar)
## To check if names work
uar_sf %>% as.data.frame() %>%
filter(str_detect(cityname, "poznan"))
## To check if names work
uar_sf %>% as.data.frame() %>%
filter(str_detect(cityname, "Poznan"))
## To check if names work
uar_sf %>% as.data.frame() %>%
filter(str_detect(cityname, "Wroclaw"))
## To check if names work
uar_sf %>% as.data.frame() %>%
filter(str_detect(cityname, "Gdynia"))
uar_sf <- uar_sf %>%
# Delete cities that I have reviewed the regulations are very week
filter(!str_detect(cityname, "Budapest"),
!str_detect(cityname, "Sofia"),
!str_detect(cityname, "Bucharest"),
!str_detect(cityname, "Suceava"),
!str_detect(cityname, "Salzburg"),
!str_detect(cityname, "Dublin"),
!str_detect(cityname, "Groningen"),
!str_detect(cityname, "Würzburg"),
# Polish cities
!str_detect(cityname, "Poznan"),
!str_detect(cityname, "Wroclaw"),
!str_detect(cityname, "Lodz")
!str_detect(cityname, "Gdynia"),
uar_sf <- uar_sf %>%
# Delete cities that I have reviewed the regulations are very week
filter(!str_detect(cityname, "Budapest"),
!str_detect(cityname, "Sofia"),
!str_detect(cityname, "Bucharest"),
!str_detect(cityname, "Suceava"),
!str_detect(cityname, "Salzburg"),
!str_detect(cityname, "Dublin"),
!str_detect(cityname, "Groningen"),
!str_detect(cityname, "Würzburg"),
# Polish cities
!str_detect(cityname, "Poznan"),
!str_detect(cityname, "Wroclaw"),
!str_detect(cityname, "Lodz").
uar_sf <- uar_sf %>%
# Delete cities that I have reviewed the regulations are very week
filter(!str_detect(cityname, "Budapest"),
!str_detect(cityname, "Sofia"),
!str_detect(cityname, "Bucharest"),
!str_detect(cityname, "Suceava"),
!str_detect(cityname, "Salzburg"),
!str_detect(cityname, "Dublin"),
!str_detect(cityname, "Groningen"),
!str_detect(cityname, "Würzburg"),
# Polish cities
!str_detect(cityname, "Poznan"),
!str_detect(cityname, "Wroclaw"),
!str_detect(cityname, "Lodz"),
!str_detect(cityname, "Gdynia"),
!str_detect(cityname, "Warsawa")) %>%
# Delete pollution emergencies schemes
filter(em_scheme == FALSE) %>%
# Delete "late" LEZ
filter(!str_detect(cityname, "Barcelona"), # applied in 2020
!str_detect(cityname, "Bordeaux"), # expected to be applied...
!str_detect(cityname, "Birmingham",) # expected to be applied...
)
## To check if names work
uar_sf %>% as.data.frame() %>%
filter(str_detect(cityname, "Gdynia"))
uar_sf$scheme %>% table()
policy_map <- leaflet() %>%
addTiles() %>%
addPolygons(data = nuts.sf,
color = "black",
weight = 1,
# opacity = NA,
fill = NA) %>%
addPolygons(
data = gzones_sf_pol,
popup = paste0("<b> Name: </b>", gzones_sf_pol$KML,
"<br/> <b> In place since: </b>", gzones_sf_pol$InPlaceSince,
"<br/> <b> Country: </b>", gzones_sf_pol$TitelLocal,
"<br/> <b> Source: </b> GreenZonesApp")) %>%
addCircleMarkers(
data = uar_sf, weight = NA,
opacity = 0.1,
color = NA,
fillColor = col_map[uar_sf$scheme_color],
fillOpacity = 0.9,
radius = col_size[uar_sf$scheme_color]*2,
popup = paste0("<b>", uar_sf$cityname, "</b> <br/>",
"<b> Scheme: </b>", uar_sf$scheme, "<br/>",
"<b> Source: </b> U.A.R")
)
htmlwidgets::saveWidget(policy_map, file="Presentations and documents/policy_map.html")
nuts.sf <- nuts.sf %>% st_make_valid()
# uar_sf <- uar_sf %>% st_make_valid()
# gzones_sf <- gzones_sf %>% st_make_valid()
# gzones_sf_pol <- gzones_sf_pol %>% st_make_valid()
get_buffer_km <- function(data_points, km){
data_points %>%
st_transform(29902) %>% # Irish grid, that uses meters
st_buffer(dist = units::set_units(km, "km")) %>% # How big is the perimeter
st_transform(crs = "+proj=longlat +datum=WGS84")
}
buffer_50_uar <- get_buffer_km(uar_sf, 50)
# ! Note! I don't need to do a buffer of 50 and 100 km of small (city-center) urban access regulations.
# I could restrict to do this for sizable LEZ
temp <- nuts.sf %>%
mutate(
with_uar_point = ifelse(
NUTS_ID %in%
(st_intersection(nuts.sf, uar_sf)$NUTS_ID %>% unique()),
TRUE, FALSE),
with_uar_50km = ifelse(
NUTS_ID %in%
(st_intersection(nuts.sf, get_buffer_km(uar_sf, 50))$NUTS_ID %>% unique()),
TRUE, FALSE),
with_uar_100km = ifelse(
NUTS_ID %in%
(st_intersection(nuts.sf, get_buffer_km(uar_sf, 100))$NUTS_ID %>% unique()),
TRUE, FALSE),
with_gzones_point = ifelse(
NUTS_ID %in%
(st_intersection(nuts.sf, gzones_sf)$NUTS_ID %>% unique()),
TRUE, FALSE),
with_gzones_50m = ifelse(
NUTS_ID %in%
(st_intersection(nuts.sf,  get_buffer_km(gzones_sf, 50))$NUTS_ID %>% unique()),
TRUE, FALSE),
with_gzones_100km = ifelse(
NUTS_ID %in%
(st_intersection(nuts.sf,  get_buffer_km(gzones_sf, 100))$NUTS_ID %>% unique()),
TRUE, FALSE)
)
ggplot(temp %>%
filter(with_uar_50km == TRUE)) +
geom_sf(aes(color = as.factor(LEVL_CODE))) +
geom_sf(data = buffer_50_uar)
# Delete cities that I have reviewed the regulations are very week
## French regions
filter(!str_detect(Bild, "Barcelona")
gzones_sf %>%
gzones_sf %>%
filter(!str_detect(Bild, "Barcelona"))
gzones_sf %>%
filter(str_detect(Bild, "Barcelona"))
gzones_sf %>%
filter(str_detect(KML, "Oberoesterreich"))
