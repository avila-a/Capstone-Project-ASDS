---
title: "Implementation ECI"
author: 'Alessandra Pasquini and Antonio Avila'
date: ""
output: 
  html_notebook:
  code_folding: show
# keep_md: true
df_print: paged
---
  
The following code returns the total (`tot1`), direct (`dir1`) and indirect (`ind1`) effects implementing MASC method. The lines of the code which does not require user's interaction are labeled as "(automatic)" in the commented lines immediately above.

```{r init, message=FALSE}
rm(list = ls())

library(Synth)
library(limSolve)
library(dplyr)
library(stringr)
library(leaflet)
library(tidyr)
library(ggplot2)
```


Get data:

```{r}
main_dta <- readRDS("data/main_dta.rds")
nuts_treated <- readRDS("data/nuts_sf_treated") %>%
  sf::st_as_sf()
```

Restrict dataset so it becomes balanced:

```{r}
# code from https://stackoverflow.com/a/25672453/12422706
balanced <- function(data, ID, TIME, VARS, required=c("all","shared")) {
    if(is.character(ID)) {
        ID <- match(ID, names(data))
    }
    if(is.character(TIME)) {
        TIME <- match(TIME, names(data))
    }
    if(missing(VARS)) { 
        VARS <- setdiff(1:ncol(data), c(ID,TIME))
    } else if (is.character(VARS)) {
        VARS <- match(VARS, names(data))
    }
    required <- match.arg(required)
    idf <- do.call(interaction, c(data[, ID, drop=FALSE], drop=TRUE))
    timef <- do.call(interaction, c(data[, TIME, drop=FALSE], drop=TRUE))
    complete <- complete.cases(data[, VARS])
    tbl <- table(idf[complete], timef[complete])
    if (required=="all") {
        keep <- which(rowSums(tbl==1)==ncol(tbl))
        idx <- as.numeric(idf) %in% keep
    } else if (required=="shared") {
        keep <- which(colSums(tbl==1)==nrow(tbl))
        idx <- as.numeric(timef) %in% keep
    }
    data[idx, ]
}
```

#### F to prepare SC

```{r}
init_sc <- function(data = data, name_treat, outcome, mediator, 
                    id_col, col_time, delay = 0,
                    t_in, 
                    announced_or_implemented = NA,
                    t_fi = NA,
                    t_fi2,
                    control_vars,
                    restr_contr_var = "contr_restr_point",
                    nuts_level = nuts_level,
                    remove_controls = NA,
                    remove_countries = NA){
  
  # Restrict the sample to NUTS region and dates of interest
  data <- data %>% as.data.frame() %>%
    # If I use a variable that has only NUTS 2 regions
    filter(nuts_level == nuts_level)  %>% 
    # Optional? restrict years ro 2001-2016, the period of mediator
    filter(time >= t_in & time <= t_fi2)
  
  # restrict the sample to a balanced panel
  data_temp <- balanced(data = data, TIME = "time", ID = "geo", 
                 VARS = c(control_vars, 
                          # id_col, col_time, 
                          outcome, mediator))
  
  # Create a numerical id for each geo
  data_temp <- data_temp %>%
  mutate(num_id = as.numeric(as.factor(geo))) %>%
  arrange(num_id)
  
  # Assign global variables:
  assign("name_treat", name_treat,
         envir = .GlobalEnv)
  assign("M", (str_detect(names(data_temp), mediator) %>% which())[1], 
         envir = .GlobalEnv)
  assign("Y", str_detect(names(data_temp), outcome) %>% which(), 
         envir = .GlobalEnv)
  assign("col_id", str_detect(names(data_temp), id_col) %>% which(), 
         envir = .GlobalEnv)
  
  assign("col_id_num", (names(data_temp) == "num_id") %>% which(), 
         envir = .GlobalEnv)
  
  assign("col_time", str_detect(names(data_temp), col_time) %>% which(), 
         envir = .GlobalEnv)
  assign("T_in", t_in , envir = .GlobalEnv)
  
  # End of treatment. Gets the date and if not calculates the implemented or announced date from announced_or_implemented
  if(!is.na(t_fi)){
    assign("T_fi", t_fi,  envir = .GlobalEnv)
  } else if (announced_or_implemented[1] == "A"){
    assign("T_fi", data_temp[data_temp$geo == name_treat, "year_announced"][1], 
           envir = .GlobalEnv)
  } else {
    assign("T_fi", data_temp[data_temp$geo == name_treat, "year_stage1"][1], 
           envir = .GlobalEnv)
  }
  
  assign("T_fi2", t_fi2 , envir = .GlobalEnv)
  assign("control_vars", control_vars , envir = .GlobalEnv)
  assign("delay", delay , envir = .GlobalEnv)
  
  # Create a list of controls
  controls <- data_temp[data_temp[, restr_contr_var] == TRUE, ]
  controls <- controls %>%
    # filter(
    #   # contr_restr_60km == TRUE, # This can be OTHER variableS
    #   contr_restr_point == TRUE,
    # ) %>%
    filter(!(country %in% remove_countries)) %>%
    filter(!(geo %in% remove_controls)) %>% 
    select(geo) %>% unique()
  
  controls <- controls$geo
  
  # Restrict data to treated and set of controls
  data_temp <- data_temp[which(is.element(data_temp[,col_id], controls) |
                       data_temp[,col_id]==name_treat),]
  
  # Create a column with treatment status (automatic)
  data_temp <- cbind(data_temp, rep(0, nrow(data_temp)))
  data_temp[data_temp[,col_id]==name_treat, ncol(data_temp)]<-1
  
  #Identifies donor pool in the numeric id column (automatic)
  controls <- data_temp[!(data_temp[,col_id]==name_treat) &
                          data_temp[,col_time]==T_in, col_id_num]
  
  assign("controls", controls , envir = .GlobalEnv)      # !!!
  
  
  #Add fake pre-treatment outcomes to optimize on pre-treatment mediator values (automatic) during the choice of matrix V
  
  #If it is decided to select the weights V to use manually skip these lines of code
  
  # Note Antonio: This restricts data on the "study period"
  data_temp <- data_temp[which(data_temp[,col_time]>=(T_in-delay) &
                       data_temp[,col_time]<=T_fi2),]
  
  data2 <- data_temp[which(data_temp[,col_time]>=(T_in-delay) &
                        data_temp[,col_time]<=(T_fi-delay)),]
  data2[,Y] <- data2[,M]
  data2 <- data2[order(data2[,col_id_num], data2[,col_time]),]
  
  data2[,col_time] <- rep((T_in-length(T_in:T_fi)-delay):(T_in-1-delay),
                          length(controls)+1) # or controls+1
  data_temp <- rbind(data2, data_temp)
  data_temp <- data_temp[order(data_temp[,col_id_num], decreasing=F),]
  # remove(data2)
  
  # #Fake starting time (automatic)
  # #This starting time is required if the pre-treatment mediator values are added as fake outcomes (see above), otherwise run the commented line below
  T_inf <- T_in-length(T_in:T_fi)-delay
  # T_inf <- T_in
  
  assign("T_inf", T_inf , envir = .GlobalEnv)      # !!!
  
  assign("data", data_temp , envir = .GlobalEnv)      # !!!
  
  #Create all the required constraints (automatic) the constraints on all pre-treatment outcome until one year before intervention and pre-treatment mediator until two years before intervention)
  
  ## Note Antonio: This depends on the delay.
  
  pretreat4 <- list(list(Y, T_in, "mean"))
  for (t in c((T_in+1):T_fi)){
    pretreat4[[length(pretreat4)+1]]<-list(Y, t, "mean")
  }
  # for (t in (T_in-delay):(T_fi-delay)){
  #    pretreat4[[length(pretreat4)+1]]<-list(M, t, "mean")
  # }
  
  pretreat4[[length(pretreat4)+1]]<-list(M, c(T_in, T_fi), "mean")
  
  #If other constraints are needed complete and run the following line 
  #(copying and pasting it as much as needed)
  #pretreat4[[length(pretreat4)+1]]<-list(column number of the variable, years of interest, "function that has to be applied to the values of that variable in those years")
  #Example 1: pretreat4[[length(pretreat4)+1]]<-list(15, 1986:1990, "mean")
  #Example 2:
  # for (c in 24:37){
  #   pretreat4[[length(pretreat4)+1]]<-list(c, 1991:1997, "mean")
  # }
  
  # Antonio: add urb_index, active_F_share, gdp_eur_hab as controls
  include_add_controls <- function(data, controls, times){
    id_controls <- which(names(data) %in% controls)
    for (c in id_controls){
      pretreat4[[length(pretreat4)+1]] <- list(c, times, "mean")
    }
    return(pretreat4)
  }
  
  pretreat4 <- include_add_controls(
    data = data_temp, 
    controls = control_vars,
    times = T_fi
  )
  
  assign("pretreat4", pretreat4 , envir = .GlobalEnv)      # !!!
  
}
```

#### F to do SC Total

```{r}
do_synth_total <- function(
  dta_imput,
  special_predictors,
  dependent,
  unit_variable,
  controls_identifier,
  time_variable,
  treatment_id,
  unit_names_variable,
  time_predictors_prior,
  time_optimize_ssr,
  time_plot,
  t_in,
  t_fi,
  t_fi2
){
#Looking for the synthetic unit for the estimation of total effect (automatic):
  prepar <- dataprep(foo = dta_imput, 
                     special.predictors = special_predictors, 
                     dependent = dependent,
                     unit.variable = unit_variable, 
                     controls.identifier = controls_identifier, 
                     time.variable = time_variable, 
                     treatment.identifier = treatment_id,
                     unit.names.variable = unit_names_variable,
                     # Ant: was c(T_inf:(T_in-delay-1), T_in:T_fi) for BOTH
                     time.predictors.prior = time_predictors_prior, # c(T_in:T_fi),
                     time.optimize.ssr = time_optimize_ssr, #c(T_in:T_fi),
                     time.plot = time_plot
  )
  
  synth_result <- synth(data.prep.obj = prepar,
                        Margin.ipop=.005,Sigf.ipop=7,Bound.ipop=6)
  
  # Do MASC-Specific stuff:
  Y1 <- dta_imput[which(dta_imput[,ncol(dta_imput)]==1 &
                          dta_imput[,col_time]>=T_in &
                     dta_imput[,col_time]<=T_fi2), Y]
  M1 <- dta_imput[which(dta_imput[,ncol(dta_imput)]==1 &
                          dta_imput[,col_time]>=T_in &
                     dta_imput[,col_time]<=T_fi2), M]
  
  Y_synth <- c()
  for (u in controls){
    Y_synth<-cbind(
      Y_synth, 
      matrix(dta_imput[which(
        dta_imput[,col_id_num]==u & 
          dta_imput[,col_time]>=T_in &
          dta_imput[,col_time]<=T_fi2), Y], ncol=1))
  }
  M_synth <- c()
  for (u in controls){
    M_synth<-cbind(
      M_synth, 
      matrix(dta_imput[which(
        dta_imput[,col_id_num]==u & 
          dta_imput[,col_time]>=T_in &
          dta_imput[,col_time]<=T_fi2), M], ncol=1))
  }
  
  #Store the results on total effect and pre and post treatment RMSPE (automatic)
  potenz1_Y <- Y1
  potenz2_Y <- Y_synth%*%synth_result$solution.w
  tot1_Y <- potenz1_Y - potenz2_Y
  PRE_RMSPE_Y <-mean(tot1_Y[1:(length(T_in:T_fi))]^2)
  POST_RMSPE_Y <- mean(tot1_Y[(length(T_in:T_fi)+1):length(T_in:T_fi2)]^2)
  # POST_RMSPE_tot1<-tot1[(length(T_in:T_fi)+1):length(T_in:T_fi2)]
  # !!!!!! this POST_RMSPE has no ^2 in the version of Alessandra!!
  
  potenz1_M <- M1
  potenz2_M <- M_synth%*%synth_result$solution.w
  tot1_M <- potenz1_M - potenz2_M
  PRE_RMSPE_M <-mean(tot1_M[1:(length(T_in:T_fi))]^2)
  POST_RMSPE_M <- mean(tot1_M[(length(T_in:T_fi)+1):length(T_in:T_fi2)]^2)
  
  print(paste0("Post/pre RMSPE (Y): ", POST_RMSPE_Y/PRE_RMSPE_Y))
  print(paste0("Post/pre RMSPE (M): ", POST_RMSPE_M/PRE_RMSPE_M))
  
  # Save results
  
  output <- list()
    # results
  output$synth.result <- synth_result
  output$path.plot <- path.plot(dataprep.res = prepar, 
                                synth.res = synth_result)
  output$synth.tables <- synth.tab(
    dataprep.res = prepar,
    synth.res = synth_result
  ) ; output$synth.tables
    # MASC-speciphic
  output$Y1 <- Y1
  output$Y_synth <- Y_synth
  
  output$M1 <- M1
  output$M_synth <- M_synth
  
  return(output)
}
```




Look at a list of treated

```{r}
main_dta %>%
  filter(treated_uz == TRUE) %>%
  filter(nuts_level == 2) %>%
  select(nuts_name, LEZ, geo) %>% unique()
```

## Prepare for Synth

* Especify the variables, periods and the delay of the mediator
* Name of the control units in the column with ID col_id (if the control units are all units in the database except the treated then do not run the two following lines)

## Calculation of total, direct and Indirect effects.

Load the database: 

* the name has to be "data"
* it has to have a column of id, 
* numeric id, 
* time
* mediator and
* outcome



```{r}
# Control Vars unemployment / temporality
control_vars_labor <- c("urb_index", 
                        "active_F_share", 
                        "gdp_eur_hab",
                        "wages_per_worker" # controls
                        # "empl_prop_F",
                        # "empl_prop_K_N"
                        # "empl_prop_A", , "empl_prop_B_E", "empl_prop_O_U",
                        # "empl_prop_G_J", 
)


# # Name of the treated unit in the column with ID "col_id"
# 
# # DE30 -> Berlin, No clear effect (DE+ CZ-ostrava)
# # DE50 -> Bremen, No clear effect (DE + DE)
# # DE21 Bayern (clear Â¿significant? effects, oposite than intuition)
# # DED5 -> Liepzig (!! not in dataset for missing values)
# # DE13 -> Freiburg, tourist city. (small) INCLREASE? in pollution, reduction in unemployment

# data <- main_dta %>% as.data.frame() %>%
#   # If I use a variable that has only NUTS 2 regions
#   filter(nuts_level == 2)  %>% 
#   # Optional? restrict years ro 2001-2016, the period of mediator
#   filter(time >= 2001 & time <= 2016)

init_sc(data = main_dta,
        nuts_level = 2,
        name_treat = "DE30",
        outcome = "unempR_T",
        mediator = "mean_pol_gdp",
        id_col = "geo",
        # id_col_num = "num_id",
        col_time = "time",
        t_in = 2001, # First year of polution data,
        announced_or_implemented = "A",
        # t_fi
        t_fi2 = 2016, # Last year of analysis
        control_vars = control_vars_labor,
        restr_contr_var = "contr_restr_60km") # True/false if it is valid control
```


Total effect (function)

```{r}
output_total <- do_synth_total(
  dta_imput = data,
  special_predictors = pretreat4,
  dependent = Y,
  unit_variable = col_id_num,
  controls_identifier = controls,
  time_variable = col_time,
  treatment_id = name_treat,
  # treatment_id = data[data[,col_id]==name_treat & data[,col_time]==T_in,col_id_num],
  unit_names_variable = col_id,
  time_predictors_prior = c(T_inf:(T_in-delay-1), T_in:T_fi),
  time_optimize_ssr = c(T_inf:(T_in-delay-1), T_in:T_fi),
  time_plot = T_inf:T_fi2,
  t_in = T_in,
  t_fi = T_fi,
  t_fi2 = T_fi2
)
```

Plots and results of Total synth:

```{r}
# Total:
data.frame(Y1 = output_total$Y1,
           Y_synth = output_total$Y_synth%*%output_total$synth.result$solution.w,
           year = T_in:T_fi2) %>%
  pivot_longer(cols = c("Y1", "w.weight")) %>%
ggplot() +
  geom_line(aes(x = year, y = value, colour = name)) +
  geom_vline(xintercept = T_fi)


# Mediator:
data.frame(M1 = output_total$M1,
           M_synth = output_total$M_synth%*%output_total$synth.result$solution.w,
           year = T_in:T_fi2) %>%
  pivot_longer(cols = c("M1", "w.weight")) %>%
ggplot() +
  geom_line(aes(x = year, y = value, colour = name)) +
  geom_vline(xintercept = T_fi)

# map:
weights_1 <- output_total$synth.tables[3] %>% as.data.frame() %>%
  arrange(desc(tab.w.w.weights)) 

donor_pool_1 <- nuts_treated %>% 
  left_join(weights_1, by = c("NUTS_ID" = "tab.w.unit.names")) %>%
  select(NUTS_ID, NUTS_NAME, tab.w.w.weights) %>%
  filter(tab.w.w.weights >= 0.001) %>%
  arrange(desc(tab.w.w.weights)); donor_pool_1 %>% as.data.frame()

map_pool_1 <- leaflet() %>% addTiles() %>%
  addPolygons(data = donor_pool_1, weight = 0.5, color = "black",
              fillColor = ~colorQuantile("RdYlGn",
                      donor_pool_1$tab.w.w.weights)(donor_pool_1$tab.w.w.weights),
              popup = paste0(
                "<b>", donor_pool_1$NUTS_ID, "</b> <br/>",
                "<b> Weight </b>", donor_pool_1$tab.w.w.weights, "<br/>")
              )
```

### Placebo treated:

```{r}
control_vars_labor <- c(
  # "urb_index",
  # "active_F_share",
  "gdp_eur_hab",
  "wages_per_worker"
  ) # controls

countries_to_remove <- c("ES", "EL", "PT")
# https://data.worldbank.org/indicator/SL.UEM.TOTL.NE.ZS?locations=DE-ES-GR-PL-NL-PT-LU-CZ-HU


list_treated <- main_dta %>%
  filter(treated_uz == TRUE) %>%
  filter(nuts_level == 2,
         year_stage1 <= 2016,
         !(geo %in% c("DEB3", "DED5"))) %>%
  select(LEZ, geo, year_stage1, year_announced) %>% 
  unique() ; list_treated

list_treated <- list_treated$geo

for (treated in list_treated){
  
  print(paste0("init ", treated))
  
  init_sc(data = main_dta,
          nuts_level = 2,
          name_treat = treated,
          outcome = "unempR_T",
          mediator = "mean_pol_gdp",
          id_col = "geo",
          # id_col_num = "num_id",
          col_time = "time",
          t_in = 2001, # First year of polution data,
          # announced_or_implemented = "A",
          t_fi = 2005,
          t_fi2 = 2016, # Last year of analysis
          control_vars = control_vars_labor,
          restr_contr_var = "contr_restr_point", # True/false if it is valid control
          remove_countries = countries_to_remove
          # remove_controls = c("EL62")
  ) 
  
  output_total <- do_synth_total(
    dta_imput = data,
    special_predictors = pretreat4,
    dependent = Y,
    unit_variable = col_id_num,
    controls_identifier = controls,
    time_variable = col_time,
    treatment_id = name_treat,
    # treatment_id = data[data[,col_id]==name_treat & data[,col_time]==T_in,col_id_num],
    unit_names_variable = col_id,
    time_predictors_prior = c(T_inf:(T_in-delay-1), T_in:T_fi),
    time_optimize_ssr = c(T_inf:(T_in-delay-1), T_in:T_fi),
    time_plot = T_inf:T_fi2,
    t_in = T_in,
    t_fi = T_fi,
    t_fi2 = T_fi2
  )
  
  print(paste0("Synth things ", treated))
  
  output_total$path.plot
  
  print(output_total$synth.tables$tab.pred %>% as.data.frame())
  print(output_total$synth.tables$tab.w %>% as.data.frame() %>%
          arrange(desc(w.weights)))
  
  # print(paste0("graph ", treated))
  
  # Total:
  plot_treated <- data.frame(Y1 = output_total$Y1,
             Y_synth = output_total$Y_synth%*%output_total$synth.result$solution.w,
             year = T_in:T_fi2) %>%
    pivot_longer(cols = c("Y1", "w.weight")) %>%
    ggplot() +
    geom_line(aes(x = year, y = value, colour = name)) +
    geom_vline(xintercept = T_fi) +
    geom_vline(xintercept = 
                 (main_dta %>%
                    filter(geo == treated))$year_stage1[1]) +
    # geom_vline(xintercept = NA) +
                 # (main_dta %>%
                 #    filter(geo == treated))$year_stage1[1]) +
    labs(
      title = paste0(treated, " ", (main_dta %>% filter(geo == treated))$year_announced[1])
                     
    )
  print(plot_treated)
  # print("should have worked")
  
  # Mediator:
  plot_mediator <- data.frame(M1 = output_total$M1,
             M_synth = output_total$M_synth%*%output_total$synth.result$solution.w,
             year = T_in:T_fi2) %>%
    pivot_longer(cols = c("M1", "w.weight")) %>%
    ggplot() +
    geom_line(aes(x = year, y = value, colour = name)) +
    geom_vline(xintercept = T_fi) +
    geom_vline(xintercept = 
                 (main_dta %>%
                    filter(geo == treated))$year_stage1[1])
  
  print(plot_mediator)
}
```

```{r}
list_treated <- main_dta %>%
  filter(treated_uz == TRUE) %>%
  filter(nuts_level == 2,
         year_stage1 <= 2016,
         !(geo %in% c("DEB3", "DED5"))) %>%
  select(LEZ, geo, year_stage1, year_announced) %>% unique() ; list_treated
```



```{r}
# map:
weights_1 <- output_total$synth.tables[3] %>% as.data.frame() %>%
  arrange(desc(tab.w.w.weights)))

donor_pool_1 <- nuts_treated %>% 
  left_join(weights_1, by = c("NUTS_ID" = "tab.w.unit.names")) %>%
  select(NUTS_ID, NUTS_NAME, tab.w.w.weights) %>%
  filter(tab.w.w.weights > 0.001) %>%
  arrange(desc(tab.w.w.weights)); donor_pool_1 %>% as.data.frame()

map_pool_1 <- leaflet() %>% addTiles() %>%
  addPolygons(data = donor_pool_1, weight = 0.5, color = "black",
              fillColor = ~colorQuantile("RdYlGn",
                      donor_pool_1$tab.w.w.weights)(donor_pool_1$tab.w.w.weights),
              popup = paste0(
                "<b>", donor_pool_1$NUTS_ID, "</b> <br/>",
                "<b> Weight </b>", donor_pool_1$tab.w.w.weights, "<br/>")
              )
map_pool_1
```


### Total Effect (before)

```{r}
#Looking for the synthetic unit for the estimation of total effect (automatic):
prepar <- dataprep(foo = data, 
                 special.predictors = pretreat4, 
                 dependent=Y,
                 unit.variable = col_id_num, 
                 controls.identifier = controls, 
                 time.variable = col_time, 
                 treatment.identifier = data[data[,col_id]==name_treat & data[,col_time]==T_in,col_id_num],
                 unit.names.variable = "geo",
          # Ant: was c(T_inf:(T_in-delay-1), T_in:T_fi) for BOTH
                 time.predictors.prior = c(T_inf:(T_in-delay-1), T_in:T_fi), # c(T_in:T_fi),
                 time.optimize.ssr = c(T_inf:(T_in-delay-1), T_in:T_fi), #c(T_in:T_fi),
                 time.plot = T_inf:T_fi2)

sintetico4 <- synth(data.prep.obj = prepar)

#If the weights V are chosen manually run the commented line below rather than those above
#sintetico4<-synth(data.prep.obj = prepar, custom.v=required weigths)

#Select the values for the graph of the outcome (and the total effect value) (automatic)

M1 <- data[which(data[,ncol(data)]==1 & data[,col_time]>=T_in &
                   data[,col_time]<=T_fi2), Y]
M_synth<-c()
for (u in controls){
  M_synth<-cbind(M_synth, 
                 matrix(data[which(data[,col_id_num]==u & 
                                     data[,col_time]>=T_in &
                                     data[,col_time]<=T_fi2), Y], ncol=1))
}

{
  #Plot the results (automatic)
  plot(T_in:T_fi2, M1, type="l", 
       ylim=c(min(c(M1, M_synth%*%sintetico4$solution.w))-sd(M1), 
              max(c(M1, M_synth%*%sintetico4$solution.w))+sd(M1)),
       xlab="Time", ylab="Outcome", main=colnames(data)[Y], 
       sub="Observed Y(1,1) and Synthetic Y(0,0)")
  
  # ! removed ", add=TRUE" from lines (Antonio)
  lines(T_in:T_fi2, M_synth%*%sintetico4$solution.w, col="red") 
  abline(v=(T_fi), lty=3) # removed +1 (the effect is in the same year for me)
}

# Added by Antonio
path.plot(dataprep.res = prepar, 
          synth.res = sintetico4)

synth.tables <- synth.tab(
                          dataprep.res = prepar,
                          synth.res = sintetico4
                          )
synth.tables[1:2]
weights_1 <- synth.tables[3] %>% as.data.frame() %>%
  arrange(desc(tab.w.w.weights))

donor_pool_1 <- nuts_treated %>% 
  left_join(weights_1, by = c("NUTS_ID" = "tab.w.unit.names")) %>%
  select(NUTS_ID, NUTS_NAME, tab.w.w.weights) %>%
  filter(tab.w.w.weights > 0.001) %>%
  arrange(desc(tab.w.w.weights)); donor_pool_1 %>% as.data.frame()

map_pool_1 <- leaflet() %>% addTiles() %>%
  addPolygons(data = donor_pool_1, weight = 0.5, color = "black",
              fillColor = ~colorQuantile("RdYlGn",
                      donor_pool_1$tab.w.w.weights)(donor_pool_1$tab.w.w.weights),
              popup = paste0(
                "<b>", donor_pool_1$NUTS_ID, "</b> <br/>",
                "<b> Weight </b>", donor_pool_1$tab.w.w.weights, "<br/>")
              )
# map_pool_1

#Store the results on total effect and pre and post treatment RMSPE (automatic)
potenz1<-M1
potenz2<-M_synth%*%sintetico4$solution.w
tot1<-potenz1-potenz2
PRE_RMSPE_tot1<-mean(tot1[1:(length(T_in:T_fi))]^2)
POST_RMSPE_tot1<-tot1[(length(T_in:T_fi)+1):length(T_in:T_fi2)]

print(paste0("Post/pre RMSPE: ", mean(POST_RMSPE_tot1)/PRE_RMSPE_tot1))


#Select the values for the graph of the mediator when the total effect is calculated (automatic)
M1<-data[which(data[,ncol(data)]==1 & data[,col_time]>=(T_in-delay) & data[,col_time]<=(T_fi2-delay)), M]
M_synth<-c()
for (u in controls){
  M_synth<-cbind(M_synth, matrix(data[which(data[,col_id_num]==u & data[,col_time]>=(T_in-delay) & data[,col_time]<=(T_fi2-delay)), M], ncol=1))
}

{
  #Plot the results (automatic)
  plot(T_in:T_fi2, M1, type="l", 
       ylim=c(min(c(M1, M_synth%*%sintetico4$solution.w))-sd(M1), 
              max(c(M1, M_synth%*%sintetico4$solution.w))+sd(M1)),
       xlab="Time", ylab="Mediator", main=colnames(data)[M], 
       sub="Observed M(1) and Synthetic M(0)")
  # !! Antonio: removed "add=TRUE"
  lines(T_in:T_fi2, M_synth%*%sintetico4$solution.w, col="red")
  abline(v=(T_fi), lty=3) # removed +1 (the effect is in the same year for me)
}


#Store the results on the effect on the mediator (automatic)
M_tot1<-(M1-M_synth%*%sintetico4$solution.w)
```

### Direct Effect

```{r}
#Use the same pre-treatment constraints (automatic)
pretreat6 <- pretreat4
#Creates vectors to store the results (automatic)
potenz1<-as.matrix(rep(NA, length(T_in:T_fi2)), 
                   nrow=length(T_in:T_fi), ncol=1)
rownames(potenz1)<-T_in:T_fi2

potenz2<-as.matrix(rep(NA, length(T_in:T_fi2)), 
                   nrow=length(T_in:T_fi), ncol=1)
rownames(potenz2)<-T_in:T_fi2

#Apply synth algorithm each post-treatment time period adding each time period an additional constraint on the mediator required for the time period of interest (i.e. given by the time period of interest minus the required delay) (automatic)
j<-1
for (i in (T_fi+1):T_fi2){
  #The weigths to select with V can be chosen adding the post-treatment mediator value as a 
  #fake outcome in the cross validation process if the following commented lines are run. If
  #this choice is made the commented synth function below has to be run instead than the 
  #non-commented ones 
  # data2<-data[which(data[,col_time]==(i-delay)),]
  # data2[,Y]<-data2[,M]
  # data2<-data2[order(data2[,col_id_num],data2[,col_time]),]
  # data2[,col_time]<-rep((T_in-length(T_in:T_fi)-delay-j), length(controls)+1)
  # databis<-rbind(data2, databis)
  # data<-data[order(data[,col_id_num],decreasing=F),]
  # remove(data2)
  # T_inf<-T_in-j
  
  #Add the post-treatment constraint on the mediator for the time period of interest (automatic)
  pretreat6[[length(pretreat6)+1]]<-list(M, i-delay, "mean")
  
  #Looking for the synthetic unit for the estimation of direct effect (automatic):
  prepar6<-dataprep(data, 
                    special.predictors=pretreat6, 
                    dependent=Y, 
                    unit.variable=col_id_num, 
                    controls.identifier = controls, 
                    time.variable =col_time, 
                    treatment.identifier =data[data[,col_id]==name_treat & data[,col_time]==T_in,col_id_num], 
                    time.predictors.prior=c(T_inf:(T_in-delay-1), T_in:T_fi),
                    time.optimize.ssr =c(T_inf:(T_in-delay-1), T_in:T_fi),
                    time.plot=T_in:T_fi2)
  
sintetico6 <-synth(data.prep.obj = prepar6,
                   custom.v = c((1/2)*as.numeric(sintetico4$solution.v),
                                rep((1/(2*j)), j)))
  
  #Store the results in the vectors previously created (automatic)
  potenz1temp<-prepar6$Y1plot
  potenz2temp<-prepar6$Y0plot%*%sintetico6$solution.w
  potenz1[rownames(potenz1)==i]<-potenz1temp[rownames(potenz1temp)==i]
  potenz2[rownames(potenz2)==i]<-potenz2temp[rownames(potenz2temp)==i]
  j<-j+1
}

# Added by Antonio
synth.tables6 <- synth.tab(
                          dataprep.res = prepar6,
                          synth.res = sintetico6
                          ); synth.tables



#Store pre-treatment period values for the synthetic unit selected when the last post-treatment period was the period of interest (automatic)
potenz1[rownames(potenz1)>=T_in & rownames(potenz1)<=T_fi]<-potenz1temp[rownames(potenz1temp)>=T_in & rownames(potenz1temp)<=T_fi]
potenz2[rownames(potenz2)>=T_in & rownames(potenz2)<=T_fi]<-potenz2temp[rownames(potenz2temp)>=T_in & rownames(potenz2temp)<=T_fi]

#Store the results on direct effect and corresponding pre and post treatment RMSPE (automatic)
dir1 <- potenz1-potenz2
PRE_RMSPE_dir1<-mean(dir1[1:(length(T_in:T_fi))]^2)
POST_RMSPE_dir1<-dir1[(length(T_in:T_fi)+1):length(T_in:T_fi2)]

#Plot the results (automatic)
{
  plot(T_in:T_fi2, potenz1, type="l", 
       ylim=c(min(c(potenz1, potenz2))-(sd(potenz1)), 
              max(c(potenz1, potenz2))+sd(potenz1)), 
       xlab="Time", ylab="Outcome", main=colnames(data)[Y], 
       sub="Observed Y(1,1) and Synthetic Y(0,1)")
  lines(T_in:T_fi2, potenz2, col="red") # removed "add=TRUE" (Antonio)
  abline(v=(T_fi+1), lty=3)
}


#Select the values for the graph of the mediator when the direct effect is calculated (automatic)
M1 <- data[which(data[,ncol(data)]==1 & data[,col_time]>=(T_in-delay) & data[,col_time]<=(T_fi2-delay)), M] 
M_synth<-c()
for (u in controls){
  M_synth<-cbind(M_synth, matrix(data[which(data[,col_id_num]==u & data[,col_time]>=(T_in-delay) & data[,col_time]<=(T_fi2-delay)), M], ncol=1))
}

#Plot the results (automatic)
plot(T_in:T_fi2, M1, type="l", 
     ylim=c(min(c(M1, M_synth%*%sintetico6$solution.w))-sd(M1), 
            max(c(M1, M_synth%*%sintetico6$solution.w))+sd(M1)),
     xlab="Time", ylab="Mediator", 
     main=colnames(data)[M], sub="Observed M(1) and Synthetic M(1)")
# removed "add=TRUE," (antonio)
lines(T_in:T_fi2, M_synth%*%sintetico6$solution.w, col="red")
abline(v=(T_fi+1), lty=3)

#Store the results on indirect effect and corresponding pre and post treatment RMSPE (automatic)
ind1 <- tot1-dir1
PRE_RMSPE_ind1<-mean(ind1[1:(length(T_in:T_fi))]^2)
POST_RMSPE_ind1<-ind1[(length(T_in:T_fi)+1):length(T_in:T_fi2)]

#Plot the results on total, direct and indirect effects in psot-treatment periods (automatic)
plot((T_fi+1):T_fi2, tot1[(length(T_in:T_fi)+1):length(T_in:T_fi2)],
     ylim=c(min(tot1, dir1, ind1)-max(sd(tot1), sd(dir1), sd(ind1)),
            max(tot1, dir1, ind1)+max(sd(tot1), sd(dir1), sd(ind1))),
     type="l", xlab="Time", ylab="Effects", col="red", lwd=3)
lines((T_fi+1):T_fi2, 
      dir1[(length(T_in:T_fi)+1):length(T_in:T_fi2)],
      col="blue", lwd=3)
lines((T_fi+1):T_fi2, 
      ind1[(length(T_in:T_fi)+1):length(T_in:T_fi2)], 
      col="green", lwd=3)
legend(T_fi2-2, max(tot1, dir1, ind1)+max(sd(tot1), sd(dir1), sd(ind1)),
       c("Total Effect", "Direct Effect", "Indirect Effect"),
       fill=c("red", "blue", "green"), bty="n")
abline(h=0)
```

### Placebo treated:

```{r}
control_vars_labor <- c(
  # "urb_index",
  # "active_F_share",
  "gdp_eur_hab",
  "wages_per_worker"
  ) # controls

countries_to_remove <- c("ES", "EL", "PT")
# https://data.worldbank.org/indicator/SL.UEM.TOTL.NE.ZS?locations=DE-ES-GR-PL-NL-PT-LU-CZ-HU


list_treated <- main_dta %>%
  filter(treated_uz == TRUE) %>%
  filter(nuts_level == 2,
         year_stage1 <= 2016,
         !(geo %in% c("DEB3", "DED5"))) %>%
  select(LEZ, geo, year_stage1, year_announced) %>% 
  unique() ; list_treated

list_treated <- list_treated$geo

for (treated in list_treated){
  
  print(paste0("init ", treated))
  
  init_sc(data = main_dta,
          nuts_level = 2,
          name_treat = treated,
          outcome = "unempR_T",
          mediator = "mean_pol_gdp",
          id_col = "geo",
          # id_col_num = "num_id",
          col_time = "time",
          t_in = 2001, # First year of polution data,
          # announced_or_implemented = "A",
          t_fi = 2005,
          t_fi2 = 2016, # Last year of analysis
          control_vars = control_vars_labor,
          restr_contr_var = "contr_restr_point", # True/false if it is valid control
          remove_countries = countries_to_remove
          # remove_controls = c("EL62")
  ) 
  
  output_total <- do_synth_total(
    dta_imput = data,
    special_predictors = pretreat4,
    dependent = Y,
    unit_variable = col_id_num,
    controls_identifier = controls,
    time_variable = col_time,
    treatment_id = name_treat,
    # treatment_id = data[data[,col_id]==name_treat & data[,col_time]==T_in,col_id_num],
    unit_names_variable = col_id,
    time_predictors_prior = c(T_inf:(T_in-delay-1), T_in:T_fi),
    time_optimize_ssr = c(T_inf:(T_in-delay-1), T_in:T_fi),
    time_plot = T_inf:T_fi2,
    t_in = T_in,
    t_fi = T_fi,
    t_fi2 = T_fi2
  )
  
  print(paste0("Synth things ", treated))
  
  output_total$path.plot
  
  print(output_total$synth.tables$tab.pred %>% as.data.frame())
  print(output_total$synth.tables$tab.w %>% as.data.frame() %>%
          arrange(desc(w.weights)))
  
  # print(paste0("graph ", treated))
  
  # Total:
  plot_treated <- data.frame(Y1 = output_total$Y1,
             Y_synth = output_total$Y_synth%*%output_total$synth.result$solution.w,
             year = T_in:T_fi2) %>%
    pivot_longer(cols = c("Y1", "w.weight")) %>%
    ggplot() +
    geom_line(aes(x = year, y = value, colour = name)) +
    geom_vline(xintercept = T_fi) +
    geom_vline(xintercept = 
                 (main_dta %>%
                    filter(geo == treated))$year_stage1[1]) +
    # geom_vline(xintercept = NA) +
                 # (main_dta %>%
                 #    filter(geo == treated))$year_stage1[1]) +
    labs(
      title = paste0(treated, " ", (main_dta %>% filter(geo == treated))$year_announced[1])
                     
    )
  print(plot_treated)
  # print("should have worked")
  
  # Mediator:
  plot_mediator <- data.frame(M1 = output_total$M1,
             M_synth = output_total$M_synth%*%output_total$synth.result$solution.w,
             year = T_in:T_fi2) %>%
    pivot_longer(cols = c("M1", "w.weight")) %>%
    ggplot() +
    geom_line(aes(x = year, y = value, colour = name)) +
    geom_vline(xintercept = T_fi) +
    geom_vline(xintercept = 
                 (main_dta %>%
                    filter(geo == treated))$year_stage1[1])
  
  print(plot_mediator)
}
```


### Real treated T (main effect):

```{r}
control_vars_labor <- c(
  # "urb_index",
  # "active_F_share",
  "gdp_eur_hab",
  "wages_per_worker"
  ) # controls

countries_to_remove <- c("ES", "EL", "PT")
# https://data.worldbank.org/indicator/SL.UEM.TOTL.NE.ZS?locations=DE-ES-GR-PL-NL-PT-LU-CZ-HU


# list_treated <- main_dta %>%
#   filter(treated_uz == TRUE) %>%
#   filter(nuts_level == 2,
#          year_stage1 <= 2016,
#          # !(geo %in% c("DEB3", "DED5"))
#          ) %>%
#   select(LEZ, geo, year_stage1, year_announced) %>% 
#   unique() ; list_treated
# 
# list_treated <- list_treated$geo

for (treated in c("DE94", "DEA3", "DE92", "DE30", "DE50")){
  
  print(paste0("init ", treated))
  
  init_sc(data = main_dta,
          nuts_level = 2,
          name_treat = treated,
          outcome = "unempR_T",
          mediator = "mean_pol_gdp",
          id_col = "geo",
          # id_col_num = "num_id",
          col_time = "time",
          t_in = 2001, # First year of polution data,
          announced_or_implemented = "A", # REAL TREATMENT
          # t_fi = 2005,
          t_fi2 = 2016, # Last year of analysis
          control_vars = control_vars_labor,
          restr_contr_var = "contr_restr_point", # True/false if it is valid control
          remove_countries = countries_to_remove
          # remove_controls = c("EL62")
  ) 
  
  output_total <- do_synth_total(
    dta_imput = data,
    special_predictors = pretreat4,
    dependent = Y,
    unit_variable = col_id_num,
    controls_identifier = controls,
    time_variable = col_time,
    treatment_id = name_treat,
    # treatment_id = data[data[,col_id]==name_treat & data[,col_time]==T_in,col_id_num],
    unit_names_variable = col_id,
    time_predictors_prior = c(T_inf:(T_in-delay-1), T_in:T_fi),
    time_optimize_ssr = c(T_inf:(T_in-delay-1), T_in:T_fi),
    time_plot = T_inf:T_fi2,
    t_in = T_in,
    t_fi = T_fi,
    t_fi2 = T_fi2
  )
  
  print(paste0("Synth things ", treated))
  
  output_total$path.plot
  
  print(output_total$synth.tables$tab.pred %>% as.data.frame())
  print(output_total$synth.tables$tab.w %>% as.data.frame() %>%
          arrange(desc(w.weights)))
  
  # print(paste0("graph ", treated))
  
  # Total:
  plot_treated <- data.frame(Y1 = output_total$Y1,
             Y_synth = output_total$Y_synth%*%output_total$synth.result$solution.w,
             year = T_in:T_fi2) %>%
    pivot_longer(cols = c("Y1", "w.weight")) %>%
    ggplot() +
    geom_line(aes(x = year, y = value, colour = name)) +
    geom_vline(xintercept = T_fi) +
    geom_vline(xintercept = 
                 (main_dta %>%
                    filter(geo == treated))$year_stage1[1]) +
    # geom_vline(xintercept = NA) +
                 # (main_dta %>%
                 #    filter(geo == treated))$year_stage1[1]) +
    labs(
      title = paste0(treated, " ", (main_dta %>% filter(geo == treated))$year_announced[1])
                     
    )
  print(plot_treated)
  # print("should have worked")
  
  # Mediator:
  plot_mediator <- data.frame(M1 = output_total$M1,
             M_synth = output_total$M_synth%*%output_total$synth.result$solution.w,
             year = T_in:T_fi2) %>%
    pivot_longer(cols = c("M1", "w.weight")) %>%
    ggplot() +
    geom_line(aes(x = year, y = value, colour = name)) +
    geom_vline(xintercept = T_fi) +
    geom_vline(xintercept = 
                 (main_dta %>%
                    filter(geo == treated))$year_stage1[1])
  
  print(plot_mediator)
}
```

### Real treated F (main effect - Female unemployment):

```{r}
control_vars_labor <- c(
  # "urb_index",
  # "active_F_share",
  "gdp_eur_hab",
  "wages_per_worker"
  ) # controls

countries_to_remove <- c("ES", "EL", "PT")
# https://data.worldbank.org/indicator/SL.UEM.TOTL.NE.ZS?locations=DE-ES-GR-PL-NL-PT-LU-CZ-HU


# list_treated <- main_dta %>%
#   filter(treated_uz == TRUE) %>%
#   filter(nuts_level == 2,
#          year_stage1 <= 2016,
#          # !(geo %in% c("DEB3", "DED5"))
#          ) %>%
#   select(LEZ, geo, year_stage1, year_announced) %>% 
#   unique() ; list_treated
# 
# list_treated <- list_treated$geo

for (treated in c("DE94", "DEA3", "DE92", "DE30", "DE50")){
  
  print(paste0("init ", treated))
  
  init_sc(data = main_dta,
          nuts_level = 2,
          name_treat = treated,
          outcome = "unempR_F",
          mediator = "mean_pol_gdp",
          id_col = "geo",
          # id_col_num = "num_id",
          col_time = "time",
          t_in = 2001, # First year of polution data,
          announced_or_implemented = "A", # REAL TREATMENT
          # t_fi = 2005,
          t_fi2 = 2016, # Last year of analysis
          control_vars = control_vars_labor,
          restr_contr_var = "contr_restr_point", # True/false if it is valid control
          remove_countries = countries_to_remove
          # remove_controls = c("EL62")
  ) 
  
  output_total <- do_synth_total(
    dta_imput = data,
    special_predictors = pretreat4,
    dependent = Y,
    unit_variable = col_id_num,
    controls_identifier = controls,
    time_variable = col_time,
    treatment_id = name_treat,
    # treatment_id = data[data[,col_id]==name_treat & data[,col_time]==T_in,col_id_num],
    unit_names_variable = col_id,
    time_predictors_prior = c(T_inf:(T_in-delay-1), T_in:T_fi),
    time_optimize_ssr = c(T_inf:(T_in-delay-1), T_in:T_fi),
    time_plot = T_inf:T_fi2,
    t_in = T_in,
    t_fi = T_fi,
    t_fi2 = T_fi2
  )
  
  print(paste0("Synth things ", treated))
  
  output_total$path.plot
  
  print(output_total$synth.tables$tab.pred %>% as.data.frame())
  print(output_total$synth.tables$tab.w %>% as.data.frame() %>%
          arrange(desc(w.weights)))
  
  # print(paste0("graph ", treated))
  
  # Total:
  plot_treated <- data.frame(Y1 = output_total$Y1,
             Y_synth = output_total$Y_synth%*%output_total$synth.result$solution.w,
             year = T_in:T_fi2) %>%
    pivot_longer(cols = c("Y1", "w.weight")) %>%
    ggplot() +
    geom_line(aes(x = year, y = value, colour = name)) +
    geom_vline(xintercept = T_fi) +
    geom_vline(xintercept = 
                 (main_dta %>%
                    filter(geo == treated))$year_stage1[1]) +
    # geom_vline(xintercept = NA) +
                 # (main_dta %>%
                 #    filter(geo == treated))$year_stage1[1]) +
    labs(
      title = paste0(treated, " ", (main_dta %>% filter(geo == treated))$year_announced[1])
                     
    )
  print(plot_treated)
  # print("should have worked")
  
  # Mediator:
  plot_mediator <- data.frame(M1 = output_total$M1,
             M_synth = output_total$M_synth%*%output_total$synth.result$solution.w,
             year = T_in:T_fi2) %>%
    pivot_longer(cols = c("M1", "w.weight")) %>%
    ggplot() +
    geom_line(aes(x = year, y = value, colour = name)) +
    geom_vline(xintercept = T_fi) +
    geom_vline(xintercept = 
                 (main_dta %>%
                    filter(geo == treated))$year_stage1[1])
  
  print(plot_mediator)
}
```
