---
title: "Download LEZ"
author: "Antonio Avila"
date: "03/02/2020"
output: html_document
---

Intro:

```{r message=FALSE, warning=FALSE}
# setwd("~/A - Estudios/LSE_ASDS/Project/PM2.5/Data Europe")

library(tidyverse)
library(dplyr)
# install.packages("osmdata")
# remotes::install_github("ropensci/osmdata")
library(osmdata)
library(sf)
library(rgdal)

library(ggmap) #To have backgrownd images
# library(mapview)
library(leaflet)

```


Info:
* OMS API: https://wiki.openstreetmap.org/wiki/API_v0.6#Retrieving_map_data_by_bounding_box:_GET_.2Fapi.2F0.6.2Fmap
* LEZ tag: https://wiki.openstreetmap.org/wiki/Tag:boundary=low%20emission%20zone?uselang=es
* OMSdata package: https://docs.ropensci.org/osmdata/
* https://wiki.openstreetmap.org/wiki/Overpass_API
* Ghent LEZ page: https://www.openstreetmap.org/relation/9626436
* GIT issue: https://github.com/ropensci/osmdata/issues/189
* Eurostat tutorial: http://ropengov.github.io/eurostat/articles/eurostat_tutorial.html
* To view results of querries directly on the web: https://tools.wmflabs.org/query2map/featurelist.php?key=boundary&value=low_emissions_zone&BBOX=-0.27,51.47,-0.20,51.50

---

This downloads the data from Open Maps:

```{r}
x <- opq(bbox = c(-0.27, 51.47, -0.20, 51.50)) %>% # Chiswick Eyot in London, U.K.
    add_osm_feature(key = 'name', value = "Thames", value_exact = FALSE) %>%
    osmdata_sf()
x$osm_multipolygons %>% st_sf() -> x

available_tags("boundary")

gh <- opq("Ghent") %>%
  add_osm_feature(key = "boundary", value = "low_emission_zone") %>%
  osmdata_sf()

poly <- gh$osm_multipolygons
poly$start_date
poly$geometry %>% plot()


getbb("London")
lond <- opq("London") %>%
  add_osm_feature(key = "boundary", value = "low_emission_zone") %>%
  osmdata_sf()
lond_geom <- lond$osm_multipolygons %>% as.data.frame()
lond_geom$geometry %>% plot()
lond_geom %>% dplyr::select(start_date, name)

uk <- opq(bbox = c(-3, 49, 0, 52), memsize = "1073741824", timeout = 30) %>%
  add_osm_feature(key = "boundary", value = "low_emission_zone") %>%
  osmdata_sf()
uk$osm_multipolygons %>% plot()
uk_geom <- uk$osm_multipolygons %>% as.data.frame()
uk_geom$geometry %>% plot()
uk_geom %>% dplyr::select(start_date, name)

getbb("London")
```

* ploting with sf: https://r-spatial.github.io/sf/articles/sf5.html

---

This scans in all the European union regions and gets the low emissions zones from Open Maps:

```{r}
uk$meta
uk$overpass_call %>% cat()

# ## Full Europe:
# lat <- seq(-10, 31, by = 2)
# long <- seq(36, 62, by =  2)

## Only Germany

lat <- seq(4, 18, by = 1)
long <- seq(47, 55, by =  1)

# lat <- seq(-1, 15, by = 2)
# long <- seq(48, 54, by =  2)
length(lat)

# final_geom <- data.frame()
# final_geom
geometries <- list()
tictoc::tic()
for (i in 2:length(lat)){ # Does this include the ones who are cutted by the bbox?
  for (j in 2:length(long)){
    cat("lat ", i-1, "long", j-1, "\n")
    # Construct coordinates with a minor shift so they overlay eachother
    coordinates <- c(lat[i-1]-0.1, long[j-1]-0.1, lat[i], long[j])
    result_querry <- opq(
      bbox = coordinates,
      memsize = "1073741824", timeout = 60) %>%
      add_osm_feature(key = "boundary", value = "low_emission_zone") %>%
      # add_osm_feature(key = "name", value = "Umweltzone") %>%
      osmdata_sf()
    result_geom <- result_querry$osm_multipolygons
    
    # result_querry <- opq(
    #   bbox = coordinates, 
    #   memsize = "1073741824", timeout = 60) %>%
    #   # add_osm_feature(key = "boundary", value = "low_emission_zone") %>%
    #   add_osm_feature(key = "name", value = "umweltzone",
    #                   value_exact = FALSE
    #                   ) %>%
    #   osmdata_sf()
    # result_geom <- result_querry$osm_multipolygons
    if(is.null(result_geom)){
      next
    }
    cat("new data!", nrow(result_geom), "\n")
    # the first time, save the base file:
    if(i == 2 & j == 5){
      final_geom <- as.data.frame(result_geom)
  } else {
    final_geom <- bind_rows(as.data.frame(result_geom), final_geom)
  }
  
  cat("been here!", "\n")
  for (maps in 1:nrow(result_geom)){
    geometries[result_geom$osm_id[maps]] <- result_geom$geometry[maps]
  }
}
}
tictoc::toc()
# Results of the grid search:

# All the dataset:
lez_data <- final_geom %>%
  select(
    osm_id, name, boundary, source, start_date, website, geometry,
    access, osmwiki
  )
lez_data <- lez_data %>% st_sf() %>% st_make_valid()

lez_data %>% class

st_crs(lez_data$geometry) <- "+proj=longlat +datum=WGS84"
plot(lez_data$geometry)

# Source of correction: https://bookdown.org/tpemartin/108-1-ntpu-datavisualization/annotation-and-maps.html
lez_data %>%
  st_geometry() -> sfc_lez_data

for(i in seq_along(sfc_lez_data)){
  names(sfc_lez_data[[i]][[1]]) <-
    1:length(names(sfc_lez_data[[i]][[1]]))
}

lez_data %>%
  st_set_geometry(
    sfc_lez_data
  ) -> lez_data2

# ggplot(lez_data2) + geom_sf()
leaflet() %>% addTiles() %>%
  addPolygons(data = as(lez_data, 'Spatial'), weight = 6, col = "red")
# Save the shape file!!

# st_write(lez_data2, "data/lez_data2/lez_data2.shp")
methods(class = "sf")

as.data.frame(result_geom)

leaflet() %>% addTiles() %>%
  addPolygons(data = lez_data, weight = 6, col = "red")

```

---

Extras and "useless" code

<!-- COMMENT EVERYTHING BELLOW

```{r}
# Add projection to geometries
geometries_2 <- lapply(geometries, function(x){
  temp <- st_sfc(x) # convert to sf
  st_crs(temp) <- "+proj=longlat +datum=WGS84" # include projection [] WHAT IS DATUM?
  return(temp)
})

# experiment_3 <- rapply(final_geom$geometry, function(x){
#   temp <- st_sfc(x) # convert to sf
#   st_crs(temp) <- "+proj=longlat +datum=WGS84" # include projection [] WHAT IS DATUM?
#   return(temp)
# })

length(geometries_2)
nrow(final_geom)

geometries_2[[21]] %>% plot(axes = T)


plot(geometries_2[[1]], graticule = TRUE, axes = TRUE)


length(geometries)
for (i in 1:length(geometries_2)){
  geometries_2[[i]] %>% plot(axes = TRUE, graticule = TRUE)
}
class(geometries_2[[1]])

union <- lapply(geometries_2, st_as_sf)

union <- do.call(rbind, union)
# union <- union %>%
#   mutate(value.geom = x) %>%
#   select(-x)

union %>% class
plot(union)
as.data.frame(union)


methods(class = "sf")

# spol <- SpatialPolygons(lapply(union, function(x){x@polygons[[1]]}))
union %>% class
?plot.sf



demo2 <- demo(nc, ask = FALSE, echo = FALSE)
demo2$value$geom %>% plot
# methods(class = "sfc")

```

Now I need to:

* Unite them all in a shape file,
* Plot it in leaflet
* 

```{r}
plot(poly)


# ?trim_osmdata()


# #get features
# uq <- getbb("germany", format_out = "polygon",
#             featuretype = "Relation:boundary") %>% 
#   opq() %>%
#   osmdata_sf()
```

