---
title: "Create SQL database"
author: '41783'
date: "27/02/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
# detach("package:raster", unload = TRUE)
library(DBI)
# library(rgdal)
```


## Index of contents

* Create database
* Include NUTS characteristics
  + Basic characteristics (size, ...)
  + If they have applied UAR or GZ and when
  + If they are rural or not (to do)
* Include NUTS3 variables
  + GDP
  + GVA / sector
  + Population / age demographics
  + Education (none included)
  + Investment
  + Population density
  + Business Demography (none included)
  
* Include NUTS2 variables
  + ...
  + ...
  
* Include data from umweltbundesamt
  + Umweltezones treatment timming
  + 
* Include data from pollution
  + Mean pollution for each NUTS3 zone
  + Population-weighted mean pollution for each NUTS3 zone
  + GDP-weighted mean pollution for each NUTS3 zone

```{r}
# create database
db <- dbConnect(RSQLite::SQLite(), "data/capstonedb")

```

## Table of characteristics of NUTS regions by year:

### NUTS 3

### gdp measures:

```{r}
# turn into wider
gdp_complete <- read.csv("data/eurostat/eurostat_gdp_complete.csv")
gdp_complete <- gdp_complete %>%
  select(-c("X")) %>%
  pivot_wider(id_cols = c("geo", "time"),
              names_from = unit, values_from = values)

# Rename variables:
gdp_complete <- gdp_complete %>%
  dplyr::rename(
    gdp_eur_hab = EUR_HAB,
    gdp_mio_pps = MIO_PPS,
    gdp_mio_eur = MIO_EUR
  )

gdp_complete %>% head()
```

### GVA measures:

```{r}
gva_complete <- read.csv("data/eurostat/eurostat_gva_complete.csv")

gva_complete <- gva_complete %>%
  # filter(currency == "MIO_EUR") %>%
  select(-c("X")) %>%
  pivot_wider(id_cols = c("geo", "time"),
              names_from = c("nace_r2"),
              values_from = values)


# Change names
# (NOTE: there is probably some work in deciding which are relevant or how to unite/divide them)
gva_complete <- gva_complete %>%
  dplyr::rename(
    gva_A = A,
    gva_B_E = "B-E",
    gva_C = C,
    gva_F = "F",
    gva_G_I = "G-I",
    gva_G_J = "G-J",
    gva_J = "J",
    gva_K = "K",
    gva_K_N = "K-N",
    gva_L = "L",
    gva_M_N = "M_N",
    gva_O_Q = "O-Q",
    gva_O_U = "O-U",
    gva_R_U = "R-U",
    gva_tot = "TOTAL"
  )

gva_complete
```



### Population age and demographics:

- To get dependency ratios and working age population

```{r}
# turn into wider
pop_age_aggr <- read.csv("data/eurostat/eurostat_pop_age_aggr.csv")
pop_age_aggr <- pop_age_aggr %>%
  filter(sex == "T") %>%
  select(-c("sex", "unit", "X")) %>%
  pivot_wider(id_cols = c("geo", "time"), 
              names_from = age, values_from = values)

# modify names:
pop_age_aggr <- pop_age_aggr %>%
  dplyr::rename(
    pop_total = TOTAL,
    pop_15_64 = "Y15-64",
    pop_65plus = Y_GE65,
    pop_less15 = Y_LT15,
    pop_unk_age = UNK
  )

pop_age_aggr %>% head()

```

### Education

```{r}
# FROM 2001 census:
pop_educ_2001 <- read.csv("data/eurostat/eurostat_pop_educ_2001.csv")

# turn into wider
pop_educ_2001 <- pop_educ_2001 %>%
  filter(sex == "T", # all sexes, ages, and work statues
         age == "TOTAL",
         wstatus == "POP") %>%
  select(-c("sex", "unit", "X", "age", "wstatus")) %>%
  pivot_wider(id_cols = c("geo"), 
              names_from = isced97, values_from = values)

# rename:
pop_educ_2001 <- pop_educ_2001 %>%
  dplyr::rename(
    edu_0_1 = ED0_1,
    edu_1 = ED1,
    edu_2 = ED2,
    edu_3 = ED3,
    edu_4 = ED4,
    edu_5_6 = ED5_6,
    edu_ned = NED,
    edu_total = ED_NED
  )

pop_educ_2001 %>% head()



# FROM NUTS2 regions yearly:
pop_educ_NUTS2 <- read.csv(
  "data/eurostat/eurostat_pop_educ_NUTS2.csv")

# turn into wider
pop_educ_NUTS2 <- pop_educ_NUTS2 %>%
  filter(sex == "T",
         age == "Y25-64") %>%
  select(-c("sex", "X", "unit")) %>%
  pivot_wider(id_cols = c("geo", "time"), 
              names_from = isced11, values_from = values)

# ED0-2	Less than primary, primary and lower Sec. educ (levels 0-2)
# ED3-8	Upper Sec., post-Sec. non-tertiary and tertiary educ (levels 3-8)
# ED3_4	Upper Sec. and post-Sec. non-tertiary educ (levels 3 and 4)
# ED5-8	Tertiary educ (levels 5-8)

# rename:
pop_educ_NUTS2 <- pop_educ_NUTS2  %>%
  dplyr::rename(
    edu_0_2 = "ED0-2",
    edu_3_4 = "ED3_4",
    edu_5_8 = "ED5-8"
  ) %>%
  select(-"ED3-8")

pop_educ_NUTS2 %>% head()

# NOTE: I could probably have the NUTS3 definition of 1 or 2 census and then use the NUTS2 to extrapolate the NUTS3 data [ ]

# Look if there is some data on this or investment in the city level.
```

### Population denisty:

```{r}
# Density
pop_dens <- read.csv("data/eurostat/eurostat_dens.csv")

pop_dens <- pop_dens %>%
  select(-c("X", "unit")) %>%
  dplyr::rename(pop_km2 = values)

pop_dens %>% head()
```

### Employment (thousand persons)

* "EMP" = "Employed persons", # Person 15y+ (or 16y+ in Iceland and Norway) who during the reference week performed +1h of work for pay, profit or family gain.
* "SAL" = "Employees"))) # Person with contract to work for employer and receives compensation


```{r}
emp_complete <- read.csv("data/eurostat/eurostat_emp_complete.csv")

emp_complete <- emp_complete %>%
  filter(wstatus == "SAL") %>%
  select(-c("X")) %>%
  pivot_wider(id_cols = c("geo", "time"),
              names_from = c("nace_r2"),
              names_prefix = "empl_",
              values_from = values)

emp_complete %>% head()
```



### Business demography (only from 2008):

```{r}
# Density
#  <- read.csv("data/eurostat_bd_employer_nace_2008.csv")
```


### NUTS 2

### Investment:

- From 2000 to 2017

> ! France, NO and DE have less data of investment

```{r}
# Intramural R&D Expenditure by Sector (https://urban.jrc.ec.europa.eu/#/en/download)

inv_cap <- read.csv(
  "data/eurostat/investment_capital_nuts2.csv")

inv_cap <- inv_cap %>%
  select(-c("X")) %>%
  pivot_wider(id_cols = c("geo", "time"),
              names_from = c("nace_r2"),
              names_prefix = "inv_",
              values_from = values) %>%
  # Make time an integer
  mutate(time = as.integer(substr(as.character(time), 1, 4)
           ))

inv_cap %>% arrange(geo) %>% head()

# INCLUDE IN DATABASE

```

### Wages (compensation) for workers:

Total compensation of workers (million euros)
NOTE: This is already corrected with additional EUROSTAT data

```{r}
# wages_n2 <- read.csv(
#   "data/eurostat/compensation_emp_nace_n2.csv")

wages_n2 <- read.csv(
  "data/eurostat/compensation_emp_nace_n2_complete.csv")

wages_n2 %>%
  dplyr::group_by(as.character(CNTR_CODE)) %>%
  arrange(desc(time)) %>%
  dplyr::summarise(
    time_min = last(time),
    time_max = first(time),
    n_obs = n()
  ) %>%
  arrange(time_min, desc(n_obs))

wages_n2 <- wages_n2 %>%
  # filter(wstatus == "WHATEVER I WANT SAL OR EMP") %>%
  select(-c("X")) %>%
  # filter(currency == "MIO_EUR") %>%
  pivot_wider(id_cols = c("geo", "time"),
              names_from = c("nace_r2"),
              names_prefix = "wages_",
              values_from = values)

wages_n2 %>% arrange(geo) %>% head()

# INCLUDE IN DATABASE

```

### Hours worked (in thousands):

_NOTE: France and Poland have MISSING_
_Additional eurostat data did not helped_

```{r}
hours_n2 <- read.csv(
  "data/eurostat/hours_worked_nuts2.csv")

hours_n2 <- hours_n2 %>%
  filter(wstatus == "SAL") %>% # SAL has wages, EMP no 
  select(-c("X", "unit")) %>%
  pivot_wider(id_cols = c("geo", "time"),
              names_from = c("nace_r2"), # "wstatus", "..."
              names_prefix = "hours_",
              values_from = values)


hours_n2 %>% head()
```


### Active pop/age, sex:

- Complete data
- in thousands

```{r}
active_pop_n2 <- read.csv(
  "data/eurostat/active_pop_age_sex_N2.csv")

active_pop_n2 <- active_pop_n2 %>%
  # filter(wstatus == "WHATEVER I WANT SAL OR EMP") %>%
  select(-c("X", "unit")) %>%
  pivot_wider(id_cols = c("geo", "time"),
              names_from = c("sex", "age"),
              names_prefix = "active_",
              values_from = values)

active_pop_n2 %>% head()
```


### Unemployment rates and totals by age, sex and "country of origin"

```{r}
unemp_rate_n2 <- read.csv("data/eurostat/unemprate_age_sex_nuts2.csv")

unemp_rate_n2 <- unemp_rate_n2 %>%
  # filter(wstatus == "WHATEVER I WANT SAL OR EMP") %>%
  select(-c("X", "unit")) %>%
  pivot_wider(id_cols = c("geo", "time"),
              names_from = c("sex"),
              names_prefix = "unempR_",
              values_from = values)

unemp_rate_n2 %>% summary()

unemp_n2 <- read.csv("data/eurostat/unemp_age_origin_nuts2.csv")

unemp_n2 <- unemp_n2 %>%
  filter(!(sex != "T" & c_birth != "TOTAL")) %>%
  select(-c("X", "unit")) %>%
  pivot_wider(id_cols = c("geo", "time"),
              names_from = c("c_birth","sex"),
              names_prefix = "unemp_",
              values_from = values)
unemp_n2 %>% names()

unemp_n2 %>% summary()
```


---

## Pollution data

```{r}
dta_pollution_nuts <- read.csv("data/pollution/dta_pollution_nuts.csv") %>%
  dplyr::select(-X) %>%
  arrange(NUTS_ID) %>%
  dplyr::rename(geo = NUTS_ID, time = year)

dta_pollution_nuts %>% names()
```

Create means for NUTS2 regions too:

```{r}
# Assing the mean value of each on the 3 values weithted by the number of pol_rasters to the immidiately supperior NUTS2 region.

dta_pollution_nuts <- gdp_complete %>% #Include NUTS 2 and NUTS 1 levels
  select(geo, time) %>%
  full_join(dta_pollution_nuts) %>%
  arrange(geo) %>%
  # Create a variables that unites NUTS2 region with its NUTS 3 dependents
  mutate(NUTS2 = substr(geo, 1, 4)) %>%
  dplyr::group_by(NUTS2, time) %>% # group by NUTS2 and time
  dplyr::mutate(mean_pol = ifelse(is.na(mean_pol),
                           weighted.mean(mean_pol, n_pol_rasters,
                                    na.rm = TRUE),
                           mean_pol),
                mean_pol_dens = ifelse(is.na(mean_pol_dens),
                           weighted.mean(mean_pol_dens,
                                         n_pol_rasters,
                                    na.rm = TRUE),
                           mean_pol_dens),
                mean_pol_gdp = ifelse(is.na(mean_pol_gdp),
                           weighted.mean(mean_pol_gdp,
                                         n_pol_rasters,
                                    na.rm = TRUE),
                           mean_pol_gdp)) %>%
  # filter(substr(geo, 1, 3) == "AL0") %>% # to check results
  ungroup() %>% dplyr::select(-NUTS2) %>%
  #Remove NUTS 1 and years that there is no data:
  filter(!is.nan(mean_pol))

dta_pollution_nuts %>% head()

dta_pollution_nuts 
```



## Unite them on a table by nuts-year:

```{r}
# from eurostat
library(eurostat)
all_geo <- eurostat_geodata_60_2016 %>% as.data.frame() %>%
  select(geo)

# nuts_time <- all_geo %>% # PAST NUTS_TIME
#   # NUTS 3 vars:
#   full_join(gdp_complete) %>% 
#   left_join(pop_age_aggr) %>%
#   left_join(emp_complete) %>%
#   left_join(gva_complete) %>%
#   left_join(pop_dens) %>% 
#   # NUTS 2 vars:
#   left_join(inv_cap) %>%
#   left_join(wages_n2) %>%
#   left_join(hours_n2) %>%
#   left_join(active_pop_n2) %>%
#   left_join(unemp_rate_n2) %>%
#   left_join(unemp_n2) %>%
#   left_join(pop_educ_NUTS2) %>%
#   # Pollution data
#   left_join(dta_pollution_nuts) %>%
#   mutate(geo = as.factor(geo)) %>%
#   arrange(geo, time)

# # Some info is getting lost if i dont do full_merge
# sum(!is.na(nuts_time))
# sum(!is.na(temp))

nuts_time <- all_geo %>%
  # NUTS 3 vars:
  full_join(gdp_complete) %>% 
  full_join(pop_age_aggr) %>%
  full_join(emp_complete) %>%
  full_join(gva_complete) %>%
  full_join(pop_dens) %>% 
  # NUTS 2 vars:
  full_join(inv_cap) %>%
  full_join(wages_n2) %>%
  full_join(hours_n2) %>%
  full_join(active_pop_n2) %>%
  full_join(unemp_rate_n2) %>%
  full_join(unemp_n2) %>%
  full_join(pop_educ_NUTS2) %>%
  # Pollution data
  full_join(dta_pollution_nuts) %>%
  mutate(geo = as.factor(geo)) %>%
  arrange(geo, time)


# TO INCLUDE:
# Education (2001 has not all the zones, NUTS2 is only for NUTS2)
# Investment: investment_capital_nuts2.csv (TO INCLUDE)
# GVA_complete
# Pollution

# To look at the merge in a year all variables are available
nuts_time %>%
  filter(time == 2016) %>% head(80)

nuts_time %>% is.na() %>% colSums() %>% as.data.frame()

nuts_time %>% names()


# Look at waswaw
nuts_time %>%
  filter(geo == "PL91") 
# temp %>%
#   filter(geo == "PL91") 

dbWriteTable(db, "nuts_time", 
             value = nuts_time, 
             overwrite = TRUE)

# Check pollution (lacking NUTS2 data)
# nuts_time %>%
#   filter(time == 2016) %>% head(80) %>%
#   select(geo, mean_pol, mean_pol_dens)
```


## Include data from umweltbundesamt:

### Treatment variables

```{r}
umweltzonen <- readxl::read_excel(
  "data/umweltbundesamt/umweltzonen.xlsx", 
                                  skip = 1)[,1:8]

names(umweltzonen) <- c("State", "LEZ", "simple_LEZ", "Status", 
                        "Stage_1", "Stage_2", "Stage_3",
                        "Announcment")

dbWriteTable(db, "umweltzonen", 
             value = umweltzonen, 
             overwrite = TRUE)
umweltzonen
```

### Air quality plans

```{r}
airq_plans <- readxl::read_excel(
  "data/umweltbundesamt/air_quality_plans.xlsx", 
                                  skip = 1)
names(airq_plans) <- c("State", "City", 
                       "Pollutant Capture", 
                       "Publication", "year")
airq_plans %>% head()

# Note: urls and links with additional info can be found at the official webpage
dbWriteTable(db, "airq_plans", 
             value = airq_plans, overwrite = TRUE)

```

Disconnect from database:

```{r}
dbDisconnect(db)
```


